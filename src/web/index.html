<!DOCTYPE html>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOS connect board</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.cdnfonts.com/css/seven-segment" rel="stylesheet">

</head>

<body>
    <div id="overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); color: white; display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="text-align: center; padding: 2em;">
            <p style="font-size: 2.5em; margin-bottom: 20px; text-align: center;">EOS connect</p>
            <p id="waiting_text" style="font-size: 1.5em; margin-bottom: 20px; text-align: center;">loading ...
            </p>
            <p id="waiting_error_text"
                style="font-size: 1.0em; font-weight: bold;  margin-bottom: 20px; text-align: center; color:rgb(241, 177, 0)">
                ...</p>
            <div
                style="border: 4px solid white; border-top: 4px solid gray; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto 0;">
            </div>
        </div>
        <div id="version_overlay"
            style="position: absolute; bottom: 10px; right: 10px; width: 100%; text-align: right; font-size: x-small;">
            EOS connect version: v00.00.00</div>
    </div>
    <div id="overlay_menu" style="display: none;">
        <div style="text-align: center; padding: 20px;">
            <p style="font-size: 1.8em; margin-bottom: 20px;">EOS connect</p>
            <hr>
            <p style="font-size: 1.3em; margin-bottom: 20px;" id="overlay_menu_head">Menu Overlay</p>
            <hr style="border-color: rgba(44, 44, 44, 0.596);">
            <p style="font-size: 1.2em; margin-bottom: 20px;" id="overlay_menu_content">This is a centered overlay menu.
            </p>
            <button onclick="document.getElementById('overlay_menu').style.display='none'"
                style="padding: 10px 20px; font-size: 1em; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <div class="container">
        <div class="top-boxes">
            <div class="top-box">
                <div class="header"><i class="fa-solid fa-battery-full"></i> Current Controls
                    <span class="header_notification" id="current_header_left"
                        style="cursor: pointer;left: 10px;min-width: 20px;right: unset;">...</span>
                    <span class="header_notification" id="current_header_right" style="min-width: 20px;">...</span>
                </div>
                <div class="content">
                    <table style="width: 100%; text-align: left;padding-top: 10px;">
                        <tr>
                            <th style="text-align: left;">Overall State</th>
                            <th style="text-align: right;" id="control_overall"></th>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <hr>
                            </td>
                        </tr>
                        <tr>
                            <td>AC Charge</td>
                            <td style="text-align: right;" id="control_ac_charge">--</td>
                        </tr>
                        <tr>
                            <td>DC Charge</td>
                            <td style="text-align: right;" id="control_dc_charge">--</td>
                        </tr>
                        <tr>
                            <td>Discharge Allowed</td>
                            <td style="text-align: right;" id="control_discharge_allowed">--</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="top-box">
                <div class="header"><i id="battery_icon_main"></i> Battery State
                    <span class="header_notification" id="battery_usable_capacity"
                        style="cursor: pointer;left: 10px;min-width: 20px;right: unset;">...</span>
                    <span class="header_notification" id="battery_soc" style="min-width: 20px;">...</span>
                </div>
                <div class="content">
                    <table style="width: 100%; text-align: left;padding-top: 10px;">
                        <tr id="next_charge_header">
                            <th style="text-align: left;">Next AC Charge</th>
                            <th style="text-align: right;" id="next_charge_time">... next charge time</th>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <hr>
                            </td>
                        </tr>
                        <tr id="next_charge_summary">
                            <td>Needed Energy</td>
                            <td colspan="2" style="text-align: right;"><span id="next_charge_amount">... kWh</span> /
                                <span id="next_charge_sum_price">... â‚¬</span>
                            </td>
                        </tr>
                        <tr id="next_charge_summary_2">
                            <td>Avg AC Charging Price</td>
                            <td colspan="2" style="text-align: right;" id="next_charge_avg_price">... kWh</td>
                        </tr>
                        <tr>
                            <td><i>Dynamic Max AC Charge Power</i></td>
                            <td colspan="2" style="text-align: right;" id="current_max_charge_dyn">--</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="top-box">
                <div class="header"><i class="fa-solid fa-charging-station"></i> eCar Charging
                    <span class="header_notification" id="evcc_mode" style="left: 10px;right: unset;">...</span>
                    <span class="header_notification" id="evcc_state">...</span>
                </div>
                <div class="content" style="text-align: center;">
                    <span id="ecar_charging_table_off">no car connected</span>
                    <table style="width: 100%; text-align: left;padding-top: 10px;" id="ecar_charging_table">
                        <tr>
                            <!-- <th style="text-align: left;">Vehicle</th> -->
                            <th style="text-align: left; cursor: help;" colspan="2"  title="name of vehicle in EVCC"><i class="fa-solid fa-car"></i> <span id="ecar_charging_name">...</span></th>
                            <!-- <th style="text-align: right;">SOC </th> -->
                            <th class="valueChange" style="text-align: right; cursor: help;" colspan="2" title="eCar SOC"><span id="ecar_charging_soc">--.- %</span> <i class="fa-solid fa-car-battery"></i></th>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <hr>
                            </td>
                        </tr>
                        <tr>                          
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_odometer" title="current vehicle mileage">--- km</td>
                            <td style="text-align: right;"><i class="fa-solid fa-gauge"> </i></td>
                            <td style="text-align: left; border-left-width: 1px; border-left-style: solid;"> <i class="fa-solid fa-road"></i></td>
                            <td style="text-align: left; cursor: help;" class="valueChange" style="text-align: right;" id="ecar_charging_range"  title="current vehicle range">--- km</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_charged" title="already charged energy">0.00 kWh</td>
                            <td style="text-align: right;"><i class="fa-solid fa-right-long"> <i class="fa-solid fa-bolt"> </i></td>                            
                            <td style="text-align: left; border-left-width: 1px; border-left-style: solid;"> <i class="fa-solid fa-bolt"> </i> <i class="fa-solid fa-check"></i></td>
                            <td style="text-align: left; cursor: help;" class="valueChange" id="ecar_charging_charged_remain" title="remaining energy to charge">0.00
                                kWh</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_duration" title="current duration of charging">00:00</td>
                            <td style="text-align: right;"><i class="fa-solid fa-right-long"></i> <i class="fa-solid fa-stopwatch"></i> </td>
                            <td style="text-align: left; border-left-width: 1px; border-left-style: solid;"> <i class="fa-solid fa-clock"></i> <i class="fa-solid fa-check"></i></td>
                            <td style="text-align: left; cursor: help;" class="valueChange"id="ecar_charging_duration_remain" title="remaining time until charging is done">00:00
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="top-box">
                <div class="header"><i class="fa-solid fa-chart-pie"></i> Statistics
                    <span class="header_notification" id="statistics_header_left"
                        style="cursor: pointer;left: 10px;min-width: 20px;right: unset;">...</span>
                    <span class="header_notification" id="statistics_header_right" style="min-width: 20px;">...</span>
                </div>
                <div class="content">
                    <table style="width: 100%; text-align: left;padding-top: 10px;">
                        <tr>
                            <th style="text-align: left;">Expense (rest of the day)</th>
                            <th style="text-align: right;" id="expense_summary"> 0.00 â‚¬</th>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <hr>
                            </td>
                        </tr>
                        <tr>
                            <td>Income</td>
                            <td colspan="2" style="text-align: right;" id="income_summary">0.00 â‚¬</td>
                        </tr>
                        <tr>
                            <td>Feed In</td>
                            <td colspan="2" style="text-align: right;" id="feed_in_summary">0.0 kWh</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="bottom-boxes">
            <div class="left-box">
                <div class="header"><i class="fa-solid fa-chart-column"></i> Optimization
                    <span class="header_notification" id="timestamp_next_run"
                        style="left: 10px;right: unset;">00:00:00</span>
                    <span class="header_notification" id="mobileview_rotate"
                        style="right: 6.0em; background-color: inherit;"
                        title="Rotate your device to landscape for a better view">
                        <i class="fa-solid fa-mobile-screen-button"></i> <i class="fa-solid fa-rotate"></i>
                    </span>
                    <span class="header_notification" id="timestamp_last_run">00:00:00</span>
                </div>
                <div class="content">
                    <canvas id="energyChart"></canvas>
                </div>
            </div>
            <div class="right-box">
                <div class="header"><i class="fa-solid fa-calendar-days"></i><span id="load_schedule_header"> Schedule
                        next 24 hours</span></div>
                <div class="content">
                    <div id="discharge_scheduler" class="table">
                        <div class="table-header">
                            <div class="table-row">
                                <div class="table-cell">time</div>
                                <div class="table-cell">Control<br><i style="font-size: smaller;"></i>target state</i>
                                </div>
                                <div class="table-cell">Price<br><i style="font-size: smaller;">ct/kWh</i></div>
                                <div class="table-cell">Expense<br><i style="font-size: smaller;">â‚¬</i></div>
                                <div class="table-cell">Income<br><i style="font-size: smaller;">â‚¬</i></div>
                            </div>
                        </div>
                        <div class="table-row">
                            &nbsp;
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="table-cell">Data 1</div>
                                <div class="table-cell">Data 2</div>
                                <div class="table-cell">Data 3</div>
                                <div class="table-cell">Data 4</div>
                                <div class="table-cell">Data 5</div>
                            </div>
                            <div class="table-row">
                                <div class="table-cell">Data 5</div>
                                <div class="table-cell">Data 6</div>
                                <div class="table-cell">Data 7</div>
                                <div class="table-cell">Data 8</div>
                                <div class="table-cell">Data 9</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let max_charge_power_w = 0;
        let inverter_mode_num = -1;
        let chartInstance = null;

        const COLOR_MODE_CHARGE_FROM_GRID = "rgb(255, 144, 144)";
        const COLOR_MODE_AVOID_DISCHARGE = "lightgray";
        const COLOR_MODE_DISCHARGE_ALLOWED = "lightgreen";
        const COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST = "#3399FF";
        const COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV = "lightgreen";
        const COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV = "darkorange";


        function isMobile() {
            return window.innerWidth <= 768;
        }

        function updateLegendVisibility() {
            if (chartInstance) {
                chartInstance.options.plugins.legend.display = !isMobile();
                if (!chartInstance.options.scales.y.ticks.font)
                    chartInstance.options.scales.y.ticks.font = {};
                chartInstance.options.scales.y.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size based on screen size

                if (!chartInstance.options.scales.y1.ticks.font)
                    chartInstance.options.scales.y1.ticks.font = {};
                chartInstance.options.scales.y1.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size based on screen size
                if (!chartInstance.options.scales.y2.ticks.font)
                    chartInstance.options.scales.y2.ticks.font = {};
                chartInstance.options.scales.y2.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size based on screen size
                if (!chartInstance.options.scales.x.ticks.font)
                    chartInstance.options.scales.x.ticks.font = {};
                chartInstance.options.scales.x.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size for x-axis based on screen size
                chartInstance.options.scales.y.title.display = !isMobile();
                chartInstance.options.scales.y1.title.display = !isMobile();
                chartInstance.options.scales.y2.title.display = !isMobile();

                chartInstance.update();
            }
        }
        window.addEventListener('resize', updateLegendVisibility);
        updateLegendVisibility();

        function writeIfValueChanged(id, value) {
            const element = document.getElementById(id);
            if (element.innerText !== value) {
                element.innerText = value;
                element.classList.add('valueChange');
                setTimeout(() => {
                    element.classList.remove('valueChange');
                }, 1000); // Remove the class after 1 second
            }
        }

        function overlayMenu(header, content) {
            const overlay = document.getElementById('overlay_menu');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'flex';
                document.getElementById('overlay_menu_head').innerHTML = header;
                document.getElementById('overlay_menu_content').innerHTML = content;
            }
        }

        function getBatteryIcon(soc_value) {
            if (soc_value > 90) {
                return '<i class="fa-solid fa-battery-full"></i>';
            } else if (soc_value > 70) {
                return '<i class="fa-solid fa-battery-three-quarters"></i>';
            } else if (soc_value > 50) {
                return '<i class="fa-solid fa-battery-half"></i>';
            } else if (soc_value > 30) {
                return '<i class="fa-solid fa-battery-quarter"></i>';
            } else {
                return '<i class="fa-solid fa-battery-empty"></i>';
            }
        }

        async function fetch_EOS_Connect_Data(filename) {
            const response = await fetch('json/' + filename + '?nocache=' + new Date().getTime());
            const data = await response.json();
            return data;
        }

        function updateChart(data_request, data_response) {
            const currentHour = new Date().getHours();

            chartInstance.data.labels = Array.from({ length: data_response["result"]["Last_Wh_pro_Stunde"].length }, (_, i) => `${(currentHour + i) % 24}:00`);
            chartInstance.data.datasets[0].data = data_response["result"]["Last_Wh_pro_Stunde"].map(value => (value / 1000).toFixed(3));
            chartInstance.data.datasets[1].data = data_request["ems"]["pv_prognose_wh"].slice(currentHour).concat(data_request["ems"]["pv_prognose_wh"].slice(24, 48)).map(value => (value / 1000).toFixed(3));
            chartInstance.data.datasets[2].data = data_response["result"]["Netzbezug_Wh_pro_Stunde"].map((value, index) => {
                const acChargeValue = data_response["ac_charge"].slice(currentHour).concat(data_response["ac_charge"].slice(24, 48)).map(value => value * max_charge_power_w);
                return ((value - acChargeValue[index]) / 1000).toFixed(3);
            });
            chartInstance.data.datasets[3].data = data_response["ac_charge"].slice(currentHour).concat(data_response["ac_charge"].slice(24, 48)).map(value => (value * max_charge_power_w / 1000).toFixed(3));
            chartInstance.data.datasets[4].data = data_response["result"]["akku_soc_pro_stunde"];
            chartInstance.data.datasets[5].data = data_response["result"]["Kosten_Euro_pro_Stunde"];
            chartInstance.data.datasets[6].data = data_response["result"]["Einnahmen_Euro_pro_Stunde"];
            chartInstance.data.datasets[7].data = data_response["result"]["Electricity_price"].map(value => value * 1000);
            chartInstance.data.datasets[8].data = data_response["discharge_allowed"].slice(currentHour).concat(data_response["discharge_allowed"].slice(24, 48));
            chartInstance.update('none'); // Update without animation
        }

        function createChart(data_request, data_response) {
            const ctx = document.getElementById('energyChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Load', data: [], backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 },
                        { label: 'PV forecast', data: [], backgroundColor: '#FFA500', borderColor: '#FF991C', borderWidth: 1, stack: 'combined' },
                        { label: 'Grid', data: [], backgroundColor: 'rgba(128, 128, 128, 0.6)', borderColor: 'rgba(211, 211, 211, 0.7)', borderWidth: 1, stack: 'combined' },
                        { label: 'AC Charge', data: [], backgroundColor: 'darkred', borderColor: 'rgba(255, 0, 0, 0.2)', borderWidth: 1, stack: 'combined' },
                        { label: 'Akku SOC', data: [], type: 'line', backgroundColor: 'blue', borderColor: 'lightblue', borderWidth: 1, yAxisID: 'y2' },
                        { label: 'Expense', data: [], type: 'line', borderColor: 'lightgreen', backgroundColor: 'green', borderWidth: 1, yAxisID: 'y1', stepped: true, hidden: true },
                        { label: 'Income', data: [], type: 'line', borderColor: 'lightyellow', backgroundColor: 'yellow', borderWidth: 1, yAxisID: 'y1', stepped: true, hidden: true },
                        { label: 'Electricity Price', data: [], type: 'line', borderColor: 'rgba(255, 69, 0, 0.8)', backgroundColor: 'rgba(255, 165, 0, 0.2)', borderWidth: 1, yAxisID: 'y1', stepped: true },
                        //{ label: 'Discharge Allowed', data: [], type: 'line', borderColor: 'lightblue', backgroundColor: 'rgba(255, 255, 255, 0.05)', borderWidth: 0, fill: true, yAxisID: 'y3' }
                        { label: 'Discharge Allowed', data: [], type: 'line', borderColor: 'rgba(144, 238, 144, 0.3)', backgroundColor: 'rgba(144, 238, 144, 0.05)', borderWidth: 1, fill: true, yAxisID: 'y3' }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Energy (kWh)', color: 'lightgray' }, grid: { color: 'rgb(54, 54, 54)' }, ticks: { color: 'lightgray' } },
                        y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Price (â‚¬)', color: 'lightgray' }, grid: { drawOnChartArea: false }, ticks: { color: 'lightgray', callback: value => value.toFixed(2) } },
                        y2: { beginAtZero: true, position: 'right', title: { display: true, text: 'Akku SOC (%)', color: 'darkgray' }, grid: { drawOnChartArea: false }, ticks: { color: 'darkgray', callback: value => value.toFixed(0) } },
                        y3: { beginAtZero: true, position: 'right', display: false, title: { display: true, text: 'AC Charge', color: 'darkgray' }, grid: { drawOnChartArea: false }, ticks: { color: 'darkgray', callback: value => value.toFixed(2) } },
                        x: { grid: { color: 'rgb(54, 54, 54)' }, ticks: { color: 'lightgray', font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { display: !isMobile(), labels: { color: 'lightgray' } }
                    },
                }
            });
            updateChart(data_request, data_response); // Feed the content immediately after creation
        }

        function setBatteryChargingData(data_response) {
            // planned charging
            var currentHour = new Date().getHours();
            price_data = data_response["result"]["Electricity_price"];
            ac_charge = data_response["ac_charge"];
            //ac_charge = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            var next_charge_time = ac_charge.slice(currentHour).findIndex((value) => value > 0);
            if (next_charge_time !== -1) {
                next_charge_time += currentHour;
                var next_charge_time_hour = next_charge_time % 24;
                document.getElementById('next_charge_time').innerText = next_charge_time_hour + ":00";
            } else {
                document.getElementById('next_charge_time').innerText = "--:--";
            }

            // calculate the average price for the next charging hours based on ac_charge
            // and calculate the next charge amount
            var next_charge_amount = 0;
            let total_price = 0;
            let total_price_count = 0;
            var foundFirst = false;
            for (let index = 0; index < ac_charge.slice(currentHour).length; index++) {
                const value = ac_charge[currentHour + index];

                if (value > 0) {
                    if (!foundFirst) {
                        foundFirst = true;
                    }
                    let current_hour_amount = value * max_charge_power_w;
                    let current_hour_price = price_data[index] * current_hour_amount; // Convert to ct/kWh
                    total_price += current_hour_price;
                    total_price_count += 1;
                    next_charge_amount += value * max_charge_power_w;
                } else if (foundFirst) {
                    break; // Stop the loop once a 0 is encountered after the first non-zero value
                }
            }

            let next_charge_avg_price = total_price / next_charge_amount * 100000;

            if (next_charge_amount === 0) {
                //document.getElementById('next_charge_header').style.display = "none";
                document.getElementById('next_charge_time').innerText = "not planned";
                document.getElementById('next_charge_summary').style.display = "none";
                document.getElementById('next_charge_summary_2').style.display = "none";

            } else {
                document.getElementById('next_charge_amount').innerText = (next_charge_amount / 1000).toFixed(1) + " kWh";
                // next_charge_sum_price
                document.getElementById('next_charge_sum_price').innerText = total_price.toFixed(2) + " â‚¬";

                if (next_charge_time !== -1) {
                    document.getElementById('next_charge_avg_price').innerText = (next_charge_avg_price).toFixed(1) + " ct/kWh";
                }

                document.getElementById('next_charge_header').style.display = "";
                document.getElementById('next_charge_summary').style.display = "";
                document.getElementById('next_charge_summary_2').style.display = "";
            }
        }

        function showCarChargingData(data_controls) {
            // car charging - current states of EVCC
            let evcc_mode = data_controls["evcc"]["charging_mode"];
            let evcc_state = data_controls["evcc"]["charging_state"];

            if (evcc_mode === "off") {
                document.getElementById('evcc_mode').innerText = "Off";
                document.getElementById('evcc_mode').style.color = "white";
            } else if (evcc_mode === "pv") {
                document.getElementById('evcc_mode').innerText = "PV";
                if (evcc_state) {
                    document.getElementById('evcc_mode').style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV;
                    document.getElementById('evcc_state').style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV;
                }
            } else if (evcc_mode === "minpv") {
                document.getElementById('evcc_mode').innerText = "Min+PV";
                if (evcc_state) {
                    document.getElementById('evcc_mode').style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV;
                    document.getElementById('evcc_state').style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV;
                }
            } else if (evcc_mode === "now") {
                document.getElementById('evcc_mode').innerText = "Fast charge";
                if (evcc_state) {
                    document.getElementById('evcc_mode').style.color = COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST;
                    document.getElementById('evcc_state').style.color = COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST;
                }
            } else {
                document.getElementById('evcc_mode').innerText = "N/A";
                document.getElementById('evcc_mode').style.color = "white";
            }

            
            if (evcc_state) {
                document.getElementById('evcc_state').innerText = "charging";
            } else {
                document.getElementById('evcc_state').innerText = "not charging";
                document.getElementById('evcc_state').style.color = "white";
            }

            if(data_controls["evcc"]["current_session"]["connected"]) {
                document.getElementById('ecar_charging_table').style.display = "";
                document.getElementById('ecar_charging_table_off').style.display = "none";
            
                // fill current session data
                writeIfValueChanged('ecar_charging_name', data_controls["evcc"]["current_session"]["vehicleName"]);
                writeIfValueChanged('ecar_charging_soc', (data_controls["evcc"]["current_session"]["vehicleSoc"]).toFixed(1) + " %");
                writeIfValueChanged('ecar_charging_odometer', data_controls["evcc"]["current_session"]["vehicleOdometer"] + " km");
                writeIfValueChanged('ecar_charging_range', data_controls["evcc"]["current_session"]["vehicleRange"] + " km");
                writeIfValueChanged('ecar_charging_charged', (data_controls["evcc"]["current_session"]["chargedEnergy"] / 1000).toFixed(1) + " kWh");
                writeIfValueChanged('ecar_charging_charged_remain', (data_controls["evcc"]["current_session"]["chargeRemainingEnergy"] / 1000).toFixed(1) + " kWh");
                let chargeDuration = data_controls["evcc"]["current_session"]["chargeDuration"];
                let hours = Math.floor(chargeDuration / 3600);
                let minutes = Math.floor((chargeDuration % 3600) / 60);
                writeIfValueChanged('ecar_charging_duration', hours.toString().padStart(2, '0') + ":" + minutes.toString().padStart(2, '0'));
                let chargeRemainingDuration = data_controls["evcc"]["current_session"]["chargeRemainingDuration"];
                let remainingHours = Math.floor(chargeRemainingDuration / 60);
                let remainingMinutes = chargeRemainingDuration % 60;
                writeIfValueChanged('ecar_charging_duration_remain', remainingHours.toString().padStart(2, '0') + ":" + remainingMinutes.toString().padStart(2, '0'));
            }
            else {
                document.getElementById('ecar_charging_table_off').style.display = "";
                document.getElementById('ecar_charging_table').style.display = "none";
            }
        }

        async function showCurrentData() {
            //console.log("------- showCurrentControls -------");
            const data_controls = await fetch_EOS_Connect_Data("current_controls.json");
            showCarChargingData(data_controls);

            inverter_mode_text = data_controls["current_states"]["inverter_mode"];
            inverter_mode_num = data_controls["current_states"]["inverter_mode_num"];
            //inverter_mode_num = 5; // for testing

            // base elements at current controls
            document.getElementById('control_ac_charge').innerText = (data_controls["current_states"]["current_ac_charge_demand"] / 1000).toFixed(1) + " kW";
            document.getElementById('control_dc_charge').innerText = (data_controls["current_states"]["current_dc_charge_demand"] / 1000).toFixed(1) + " kW";
            document.getElementById('control_discharge_allowed').innerText = (data_controls["current_states"]["current_discharge_allowed"] === true ? "Yes" : "No");
            document.getElementById('control_overall').innerText = inverter_mode_text.replace("MODE ", "");
            document.getElementById('battery_soc').innerText = data_controls["battery"]["soc"] + " %";
            // set battery icon
            document.getElementById('battery_icon_main').innerHTML = getBatteryIcon(data_controls["battery"]["soc"]);
            document.getElementById('current_max_charge_dyn').innerHTML = "<i>" + data_controls["battery"]["max_charge_power_dyn"].toFixed(0) + " W</i>";
            // set battery usable energy
            document.getElementById('battery_usable_capacity').innerHTML = '<i class="fa-solid fa-database"></i> ' + (data_controls["battery"]["usable_capacity"] / 1000).toFixed(1) + ' <span style="font-size: 0.6em;">kWh</span>';
            document.getElementById('battery_usable_capacity').title = "usable capacity: " + (data_controls["battery"]["usable_capacity"] / 1000).toFixed(1) + " kWh";

            // dependent on inverter mode show the icon
            //0: "MODE_CHARGE_FROM_GRID",
            //1: "MODE_AVOID_DISCHARGE",
            //2: "MODE_DISCHARGE_ALLOWED",
            //3: "MODE_AVOID_DISCHARGE_EVCC_FAST",
            //4: "MODE_DISCHARGE_ALLOWED_EVCC_PV",
            //5: "MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV",

            const iconElement = document.getElementById('current_header_right');
            iconElement.innerHTML = ""; // Clear previous content

            const icons = [
                { icon: "fa-plug-circle-bolt", color: COLOR_MODE_CHARGE_FROM_GRID, title: "Charge from grid" },
                { icon: "fa-lock", color: COLOR_MODE_AVOID_DISCHARGE, title: "Avoid discharge" },
                { icon: "fa-battery-half", color: COLOR_MODE_DISCHARGE_ALLOWED, title: "Discharge allowed" },
                { icon: "fa-charging-station", color: COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST, title: "Avoid discharge due to e-car fast charge" },
                { icon: "fa-charging-station", color: COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV, title: "Discharge allowed during e-car charging in pv mode" },
                { icon: "fa-charging-station", color: COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV, title: "Discharge allowed during e-car charging in min+pv mode" }
            ];
            const { icon, color, title } = icons[inverter_mode_num] || {};
            iconElement.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            iconElement.style.color = color || "";
            iconElement.title = title || "";

            // energy optimization - last result received
            const timestamp_last_run = new Date(data_controls.state.last_response_timestamp);
            const timestamp_next_run = new Date(data_controls.state.next_run);
            const timestamp_last_run_formatted = timestamp_last_run.toLocaleString('de-DE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timestamp_last_run').innerText = timestamp_last_run_formatted;
            document.getElementById('timestamp_last_run').title = "last run";
            let time_to_next_run = Math.floor((timestamp_next_run - new Date()) / 1000);
            let minutes = Math.floor(Math.abs(time_to_next_run) / 60); // Correct calculation for minutes
            let seconds = Math.abs(time_to_next_run % 60);
            if (time_to_next_run < 0) {
                document.getElementById('timestamp_next_run').style.color = "lightgreen";
                // add alt text to the time field
                document.getElementById('timestamp_next_run').title = "current optimization running for " + minutes.toString().padStart(2, '0') + " min and " + seconds.toString().padStart(2, '0') + " sec";
            } else {
                document.getElementById('timestamp_next_run').style.color = "orange";
                document.getElementById('timestamp_next_run').title = "next optimization run in " + minutes.toString().padStart(2, '0') + " min and " + seconds.toString().padStart(2, '0') + " sec";
            }
            document.getElementById('timestamp_next_run').innerText = minutes.toString().padStart(2, '0') + ":" + seconds.toString().padStart(2, '0') + " min";

            // display current eos connect version
            document.getElementById('version_overlay').innerText = "EOS connect version: " + data_controls["eos_connect_version"];

            document.getElementById('current_header_left').innerHTML = '<i class="fa-solid fa-circle-info"></i>'; // + " " + data_controls["eos_connect_version"];
            document.getElementById('current_header_left').title = "EOS connect version: " + data_controls["eos_connect_version"];
            document.getElementById('current_header_left').addEventListener('click', function () {
                overlayMenu(
                    "version",
                    '<i style="font-size: smaller;">currently installed:</i><br><br>' + data_controls["eos_connect_version"] + "<br><br>" +
                    "<hr style='border-color: rgba(44, 44, 44, 0.596);'>" +
                    '<div style="font-size: 2em;">' +
                    '<a href="https://github.com/ohAnd/EOS_connect" target="_blank" style="padding-right: 20px; color: inherit; onmousedown="this.style.color=\'#551A8B\'" onmouseup="this.style.color=\'inherit\'""><i class="fa-brands fa-square-github"></i></a>' +
                    '<a href="https://github.com/ohAnd/ha_addons/blob/master/eos_connect/CHANGELOG.md" target="_blank"  style="padding-right: 20px; color: inherit; onmousedown="this.style.color=\'#551A8B\'" onmouseup="this.style.color=\'inherit\'""><i class="fa-solid fa-file-invoice"></i></a>' +
                    '<a href="https://github.com/ohAnd/EOS_connect/issues" target="_blank"  style="color: inherit; onmousedown="this.style.color=\'#551A8B\'" onmouseup="this.style.color=\'inherit\'""><i class="fa-solid fa-bug"></i></a>' +
                    "</div>"
                );
            });
        }

        function showStatistics(data_request, data_response) {
            // set the values for solar yield today and tomorrow
            let yield_today = data_request["ems"]["pv_prognose_wh"].slice(0, 24).reduce((acc, value) => acc + value, 0) / 1000;
            let yield_tomorrow = data_request["ems"]["pv_prognose_wh"].slice(24, 48).reduce((acc, value) => acc + value, 0) / 1000;
            document.getElementById('statistics_header_left').innerHTML = '<i class="fa-solid fa-solar-panel"></i> ' + yield_today.toFixed(1) + ' <span style="font-size: 0.6em;">kWh</span>';
            document.getElementById('statistics_header_left').title = "Solar yield for today";
            document.getElementById('statistics_header_right').innerHTML = + yield_tomorrow.toFixed(1) + ' <span style="font-size: 0.6em;">kWh</span>' + ' <i class="fa-solid fa-solar-panel"></i> ';
            document.getElementById('statistics_header_right').title = "Solar yield for tomorrow";

            // set expense and income for today and tomorrow
            expense_data = data_response["result"]["Kosten_Euro_pro_Stunde"];
            income_data = data_response["result"]["Einnahmen_Euro_pro_Stunde"];
            feed_in_data = data_response["result"]["Netzeinspeisung_Wh_pro_Stunde"];

            let currentHour = new Date().getHours();
            let expense_today = expense_data.slice(0, 24 - currentHour).reduce((acc, value) => acc + value, 0).toFixed(2);
            document.getElementById('expense_summary').innerText = expense_today + " â‚¬";
            document.getElementById('expense_summary').title = "Expense for the rest of the day";

            // set income for rest of the day
            let income_today = income_data.slice(0, 24 - currentHour).reduce((acc, value) => acc + value, 0).toFixed(2);
            document.getElementById('income_summary').innerText = income_today + " â‚¬";
            document.getElementById('income_summary').title = "Income for the rest of the day";

            // set feed in for rest of the day
            let feed_in_today = feed_in_data.slice(0, 24 - currentHour).reduce((acc, value) => acc + value, 0) / 1000;
            document.getElementById('feed_in_summary').innerText = feed_in_today.toFixed(1) + " kWh";
            document.getElementById('feed_in_summary').title = "Feed in for the rest of the day";

        }

        function showSchedule(data_request, data_response) {
            //console.log("------- showSchedule -------");
            var currentHour = new Date(data_response["timestamp"]).getHours();
            var discharge_allowed = data_response["discharge_allowed"];
            var ac_charge = data_response["ac_charge"];
            // for testing
            //discharge_allowed = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0];
            //ac_charge = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];

            ac_charge = ac_charge.map((value, index) => value * max_charge_power_w);
            var priceData = data_response["result"]["Electricity_price"];
            var expenseData = data_response["result"]["Kosten_Euro_pro_Stunde"];
            var incomeData = data_response["result"]["Einnahmen_Euro_pro_Stunde"];

            // clear all entries in div discharge_scheduler
            var tableBody = document.querySelector("#discharge_scheduler .table-body");
            tableBody.innerHTML = '';

            priceData.forEach((value, index) => {
                if (index > 23) return;

                if ((index + 1) % 4 === 0 && (index + 1) !== 0) {
                    var row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.borderBottom = "1px solid #707070";
                    row.style.height = "5px";
                    tableBody.appendChild(row); // Append the row to the table body
                    var row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.height = "5px";
                    tableBody.appendChild(row); // Append the row to the table body
                }

                var row = document.createElement('div');
                row.className = 'table-row';

                var cell1 = document.createElement('div');
                cell1.className = 'table-cell';
                cell1.innerHTML = ((index + currentHour) % 24) + ":00";
                cell1.style.textAlign = "right";
                row.appendChild(cell1);

                var cell2 = document.createElement('div');
                cell2.className = 'table-cell';
                const buttonDiv = document.createElement('div');
                buttonDiv.style.border = "1px solid #ccc";
                buttonDiv.style.borderRadius = "5px";
                buttonDiv.style.borderColor = "darkgray";
                buttonDiv.style.width = "50px";
                buttonDiv.style.display = "inline-block";
                buttonDiv.style.textAlign = "center";

                if (index === 0 && inverter_mode_num > 2) {
                    // override first hour - if eos connect overriding eos
                    if (inverter_mode_num === 3) { // MODE_AVOID_DISCHARGE_EVCC_FAST
                        //buttonDiv.style.backgroundColor = "#3399FF";
                        buttonDiv.style.color = COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST;
                        buttonDiv.innerHTML = " <i class='fa-solid fa-charging-station'></i> <i class='fa-solid fa-lock'></i> ";
                    } else if (inverter_mode_num === 4) { // MODE_DISCHARGE_ALLOWED_EVCC_PV
                        //buttonDiv.style.backgroundColor = "#3399FF";
                        buttonDiv.style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV;
                        buttonDiv.innerHTML = " <i class='fa-solid fa-charging-station'></i> <i class='fa-solid fa-battery-half'></i> ";
                    } else if (inverter_mode_num === 5) { //MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV
                        //buttonDiv.style.backgroundColor = "rgb(255, 144, 144)";
                        buttonDiv.style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV;
                        buttonDiv.innerHTML = " <i class='fa-solid fa-charging-station'></i> <i class='fa-solid fa-battery-half'></i> ";
                    }
                } else if (discharge_allowed[(index + currentHour)] === 1) {
                    //buttonDiv.style.backgroundColor = "grey";
                    buttonDiv.style.color = COLOR_MODE_DISCHARGE_ALLOWED;
                    buttonDiv.innerHTML = "<i class='fa-solid fa-battery-half'></i>";
                } else if (ac_charge[(index + currentHour)]) {
                    //buttonDiv.style.backgroundColor = color_bat_grid_charging;
                    buttonDiv.style.color = COLOR_MODE_CHARGE_FROM_GRID;
                    let acChargeValue = ac_charge[(index + currentHour)] === 0 ? "" : (ac_charge[(index + currentHour)] / 1000).toFixed(1) + '<span style="font-size: xx-small;"> kWh<span>';
                    buttonDiv.innerHTML = "<i class='fa-solid fa-plug-circle-bolt'></i> " + acChargeValue;
                    buttonDiv.style.padding = "0 10px";
                    buttonDiv.style.width = "";
                } else {
                    //buttonDiv.style.backgroundColor = "";
                    buttonDiv.style.color = COLOR_MODE_AVOID_DISCHARGE;
                    buttonDiv.innerHTML = "<i class='fa-solid fa-lock'></i>";
                }

                cell2.appendChild(buttonDiv);
                cell2.style.textAlign = "center";
                row.appendChild(cell2);

                var cell3 = document.createElement('div');
                cell3.className = 'table-cell';
                cell3.innerHTML = (priceData[index] * 100000).toFixed(1);
                cell3.style.textAlign = "center";
                row.appendChild(cell3);

                var cell4 = document.createElement('div');
                cell4.className = 'table-cell';
                cell4.innerHTML = (expenseData[index]).toFixed(2);
                cell4.style.textAlign = "center";
                row.appendChild(cell4);

                var cell5 = document.createElement('div');
                cell5.className = 'table-cell';
                cell5.innerHTML = (incomeData[index]).toFixed(2);
                cell5.style.textAlign = "center";
                row.appendChild(cell5);

                tableBody.appendChild(row);
            });
        }

        function handlingErrorInResponse(data_response) {

            if (!data_response || !data_response["result"] || !data_response["result"]["Last_Wh_pro_Stunde"] || data_response["result"]["Last_Wh_pro_Stunde"].length === 0) {
                document.getElementById('overlay').style.display = 'flex';
                if (data_response["error"]) {
                    if (data_response["error"].includes("Request timed out")) {
                        document.getElementById('waiting_text').innerText = "No processing possible - connection to EOS server timed out";
                        document.getElementById('waiting_error_text').innerText = "Error: " + data_response["error"];
                    }
                    else if (data_response["error"].includes("422 Client Error: Unprocessable Entity")) {
                        document.getElementById('waiting_text').innerText = "Check your configuration! - EOS cannot process the request...";
                        document.getElementById('waiting_error_text').innerText = "Error: " + data_response["error"];
                    }
                    else {
                        document.getElementById('waiting_text').innerText = "No data available...";
                        document.getElementById('waiting_error_text').innerText = "no detailed error information available - error message: " + data_response["error"];
                    }
                } else if (data_response["status"]) {
                    document.getElementById('waiting_text').innerText = data_response["status"];
                    document.getElementById('waiting_error_text').innerText = data_response["message"];
                }
                else {
                    document.getElementById('waiting_text').innerText = "Waiting for first data...";
                    document.getElementById('waiting_error_text').innerText = "";
                }
                return true;
            }
        }

        // function to observe changed values of doc elements from class "valueChange" and animate the change
        Array.from(document.getElementsByClassName("valueChange")).forEach(function (element) {
            const observer = new MutationObserver(function (mutationsList, observer) {
                const elem = mutationsList[0].target;
                // elem.classList.add("animateValue");
                elem.style.color = "black"; //"#2196f3"; //lightgreen
                //elem.style.fontSize = "95%";
                setTimeout(function () {
                    elem.style.color = "inherit";// "#eee";
                    //elem.style.fontSize = "100%";
                }, 1000);

            });
            observer.observe(element, { characterData: false, childList: true, attributes: false });
        });

        async function init() {
            // base chart
            const data_request = await fetch_EOS_Connect_Data("optimize_request.json");
            // max_charge_power_w according to optimize_request api version
            max_charge_power_w = data_request["pv_akku"] && data_request["pv_akku"].hasOwnProperty("max_ladeleistung_w") ? data_request["pv_akku"]["max_ladeleistung_w"] : data_request["pv_akku"] ? data_request["pv_akku"]["max_charge_power_w"] : 0;
            const data_response = await fetch_EOS_Connect_Data("optimize_response.json");

            await showCurrentData();

            // error handling
            if (handlingErrorInResponse(data_response)) {
                return;
            }

            if (chartInstance) {
                updateChart(data_request, data_response);
                document.getElementById('overlay').style.display = 'none';
            } else {
                createChart(data_request, data_response);
                document.getElementById('overlay').style.display = 'none';
            }

            showStatistics(data_request, data_response);
            showSchedule(data_request, data_response);
            setBatteryChargingData(data_response);
            updateLegendVisibility();
        }

        init();
        setInterval(init, 5000);
    </script>
</body>

</html>